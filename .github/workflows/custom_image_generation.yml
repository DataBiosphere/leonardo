# This will automatically use the sbt version in project/build.properties
name: Custom Image Generation

#TODO: should only be `workflow_dispatch` eventually, after testing
on:
#TODO: REMOVE BEFORE MERGE
  push:
    branches:
      - 'jc-image-action'
  workflow_dispatch:
    inputs:
      run-dataproc-override:
        description: 'Set this to `true` to force dataproc image generation script to run regardless of if there are changes to generation script.'
        required: false
        default: false
        type: boolean
      run-gce-override:
        description: 'Set this to `true` to force gce image generation script to run regardless of if there are changes to generation script.'
        required: false
        default: false
        type: boolean

env:
  GOOGLE_PROJECT: broad-dsp-gcr-public
  GOOGLE_CREDENTIAL_FILE_NAME: image-build-account.json
  REGION: us-central1
  ZONE: us-central1-a
  OUTPUT_BASE_NAME: custom-leo

jobs:
  run-image-generation-script-gce:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    env:
      GCE_IMAGE_BUCKET: gs://leo-gce-image-creation-logs
      DAISY_IMAGE: gcr.io/compute-image-tools/daisy:release
      GCP_DAISY_GCR_KEY: ${{secrets.GCP_DAISY_GCR_KEY}}

    steps:
    - uses: actions/checkout@v3

    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        # Centralized in dsp-tools-k8s; ask in #dsp-devops-champions for help troubleshooting
        workload_identity_provider: 'projects/1038484894585/locations/global/workloadIdentityPools/github-wi-pool/providers/github-wi-provider'
        service_account: 'image-build-account@broad-dsp-gcr-public.iam.gserviceaccount.com'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v1'

    - name: Create svc acct file
#      run: 'echo "$GCP_DAISY_GCR_KEY" | base64 -d > "$GITHUB_WORKSPACE/jenkins/gce-custom-images/$GOOGLE_CREDENTIAL_FILE_NAME"'
      run: 'echo "$GCP_DAISY_GCR_KEY" | base64 -d > "$GITHUB_WORKSPACE/jenkins/gce-custom-images/application_default_credentials.json"'
      shell: bash
      env:
        GCP_DAISY_GCR_KEY: ${{secrets.GCP_DAISY_GCR_KEY}}

    - name: setup for script
      run: |
        gsutil ls $GCE_IMAGE_BUCKET || gsutil mb -p $GOOGLE_PROJECT -l $REGION $GCE_IMAGE_BUCKET
        docker pull $DAISY_IMAGE
        ls $GITHUB_WORKSPACE/jenkins/gce-custom-images
        mkdir $GITHUB_WORKSPACE/jenkins/gce-custom-images/${OUTPUT_BASE_NAME}-gce-cos-image-${GITHUB_SHA:0:6}
        ls $GITHUB_WORKSPACE/jenkins/gce-custom-images

    - name: run script
      run: |
         bash $GITHUB_WORKSPACE/jenkins/gce-custom-images/create_gce_image.sh

  run-image-generate-script-dataproc:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    env:
      DATAPROC_IMAGE_VERSION: 2.0.51-debian10
      DATAPROC_IMAGE_VERSION_FORMATTED: 2-0-51-debian10
      DATAPROC_IMAGE_BUCKET: gs://leo-dataproc-image-creation-logs
      TEST_NAME: ${OUTPUT_BASE_NAME}-gce-cos-image-${GITHUB_SHA:0:6}
      GCP_DAISY_GCR_KEY: ${{secrets.GCP_DAISY_GCR_KEY}}

    steps:
      - uses: actions/checkout@v3

      - name: Create svc acct file
        run: 'echo "$GCP_DAISY_GCR_KEY" | base64 -d > "$GITHUB_WORKSPACE/jenkins/dataproc-custom-images/$GOOGLE_CREDENTIAL_FILE_NAME"'
        shell: bash
        env:
          GCP_DAISY_GCR_KEY: ${{secrets.GCP_DAISY_GCR_KEY}}

      - name: Init submodule
        run: |
          git submodule sync
          git submodule update --init --recursive

      - name: Run image generation script
        run: |
#          docker run --rm -v $GITHUB_WORKSPACE/jenkins/dataproc-custom-images:/work gcr.io/google.com/cloudsdktool/cloud-sdk:266.0.0 bash -c "cd /work/dataproc-custom-images \
#          && gcloud auth activate-service-account --key-file=/work/$GOOGLE_CREDENTIAL_FILE_NAME \
#          && gcloud auth configure-docker --quiet \
#          && gcloud config set dataproc/region us-central1 \
#          && python generate_custom_image.py \
#          --image-name "${OUTPUT_BASE_NAME}-image-dataproc-${DATAPROC_IMAGE_VERSION_FORMATTED}-${GITHUB_SHA:0:6}" \
#          --dataproc-version "${DATAPROC_IMAGE_VERSION}" \
#          --customization-script ../prepare-custom-leonardo-jupyter-dataproc-image.sh \
#          --zone $ZONE \
#          --gcs-bucket $DATAPROC_IMAGE_BUCKET \
#          --project-id=$GOOGLE_PROJECT \
#          --disk-size=120"
